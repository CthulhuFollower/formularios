<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuestionario clínico · Configuración del sistema</title>

      <style>
    @import url("https://fonts.googleapis.com/css2?family=Literata:opsz,wght@7..72,600;7..72,700&family=Source+Sans+3:wght@400;500;600;700&display=swap");

    :root{
      --bg0:#f3f7fb;
      --bg1:#edf4f8;
      --bg2:#f7f3ee;

      --card:#ffffff;
      --card-soft:#f9fcff;

      --text:#243646;
      --muted:#5f7385;
      --muted2:#7e90a0;

      --line:#d9e4ec;
      --line-strong:#c7d6e1;

      --brand:#2e7c9c;
      --brand2:#44a598;
      --warm:#c98764;

      --ok:#3f9372;
      --warn:#b57a35;
      --danger:#b14d4d;

      --shadow:0 20px 40px rgba(40,74,98,.10);
      --shadow-soft:0 10px 22px rgba(40,74,98,.08);

      --r:22px;
      --r2:14px;

      --focus:0 0 0 4px rgba(46,124,156,.18), 0 0 0 1px rgba(46,124,156,.40);

      color-scheme: light;
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }

    body{
      margin:0;
      min-height:100vh;
      position:relative;
      font-family:"Source Sans 3", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size:18px;
      line-height:1.52;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at -5% -5%, rgba(77,153,186,.16), transparent 58%),
        radial-gradient(950px 650px at 105% 8%, rgba(68,165,152,.14), transparent 62%),
        radial-gradient(800px 620px at 50% 110%, rgba(201,135,100,.13), transparent 64%),
        linear-gradient(165deg, var(--bg0) 0%, var(--bg1) 54%, var(--bg2) 100%);
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 1px 1px, rgba(112,136,154,.14) 1px, transparent 1px);
      background-size:22px 22px;
      mask-image:linear-gradient(to bottom, rgba(0,0,0,.18), transparent 70%);
      opacity:.35;
    }

    a{ color:inherit; }

    .wrap{
      max-width:1280px;
      margin:34px auto 170px;
      padding:0 20px;
      position:relative;
      z-index:1;
    }

    .hero{
      position:relative;
      border-radius:var(--r);
      padding:26px 28px 18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(248,252,255,.94));
      box-shadow:var(--shadow-soft);
      overflow:hidden;
      animation:riseIn .55s ease both;
    }

    .hero::before{
      content:"";
      position:absolute;
      inset:0 0 auto;
      height:6px;
      background:linear-gradient(90deg, var(--brand), var(--brand2), var(--warm));
      opacity:.9;
      pointer-events:none;
    }

    .hero::after{
      content:"";
      position:absolute;
      width:320px;
      height:160px;
      right:-120px;
      top:-90px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(68,165,152,.20), rgba(68,165,152,0));
      pointer-events:none;
      animation:drift 10s ease-in-out infinite;
    }

    .hero-top{
      position:relative;
      display:flex;
      gap:20px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:flex-start;
      gap:14px;
      min-width:330px;
      flex:1.2;
    }

    .mark{
      width:56px;
      height:56px;
      border-radius:16px;
      background:
        radial-gradient(20px 20px at 28% 24%, rgba(255,255,255,.7), transparent 65%),
        linear-gradient(145deg, rgba(46,124,156,.95), rgba(68,165,152,.88));
      border:1px solid rgba(255,255,255,.8);
      box-shadow:0 14px 26px rgba(46,124,156,.22);
      display:grid;
      place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }

    .mark svg{ opacity:.95; transform:translateY(1px); }

    h1{
      margin:0;
      font-family:"Literata", "Georgia", serif;
      font-size:2.05rem;
      line-height:1.15;
      letter-spacing:.2px;
      color:#1f3445;
    }

    .subtitle{
      margin:9px 0 0;
      color:var(--muted);
      font-size:1.03rem;
      max-width:72ch;
      line-height:1.52;
    }

    .subtitle span{ color:#8f5f45 !important; font-weight:700; }

    .status{
      display:flex;
      flex-direction:column;
      gap:11px;
      min-width:300px;
      flex:1;
      align-items:flex-end;
    }

    .progress{
      width:min(450px,100%);
      height:13px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      overflow:hidden;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.9);
    }

    .progress > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg, var(--brand), var(--brand2), var(--warm));
      transition:width .32s ease;
    }

    .statusline{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:.88rem;
    }

    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:7px 11px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      background:rgba(255,255,255,.88);
      color:#5a7082;
      box-shadow:0 4px 12px rgba(40,74,98,.06);
    }

    .pill strong{ color:#2d485d; font-weight:800; }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns:290px 1fr;
      gap:18px;
      align-items:start;
    }

    @media (max-width:1080px){ .grid{ grid-template-columns:1fr; } }

    .nav{
      position:sticky;
      top:18px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(247,252,255,.92));
      box-shadow:var(--shadow-soft);
      overflow:hidden;
      animation:riseIn .55s .07s ease both;
    }

    .nav-head{
      padding:15px 15px 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(245,251,255,.95), rgba(255,255,255,.94));
    }

    .nav-title{
      margin:0;
      font-size:.9rem;
      color:var(--muted);
      letter-spacing:.25px;
      font-weight:700;
    }

    .nav-list{
      list-style:none;
      margin:0;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:9px;
    }

    .nav a{
      text-decoration:none;
      border:1px solid transparent;
      border-radius:13px;
      padding:11px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      color:#355367;
      font-weight:700;
      background:transparent;
      transition:all .15s ease;
    }

    .nav a:hover{
      background:rgba(255,255,255,.84);
      border-color:var(--line);
      transform:translateY(-1px);
    }

    .nav a.active{
      background:linear-gradient(135deg, rgba(77,153,186,.16), rgba(68,165,152,.16));
      border-color:#b9d2df;
      box-shadow:0 8px 16px rgba(40,74,98,.10);
    }

    .dot{
      width:11px;
      height:11px;
      border-radius:999px;
      border:1px solid #bbced9;
      background:#e9f1f6;
      flex:0 0 auto;
    }

    .dot.done{
      border-color:#4c9174;
      background:#4c9174;
      box-shadow:0 0 0 3px rgba(76,145,116,.20);
    }

    .dot.partial{
      border-color:#b07b5b;
      background:#cb8d68;
      box-shadow:0 0 0 3px rgba(201,135,100,.22);
    }

    .nav small{
      margin-left:auto;
      font-size:.8rem;
      color:var(--muted);
      font-variant-numeric:tabular-nums;
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--card);
      box-shadow:var(--shadow);
      overflow:hidden;
      animation:riseIn .55s .15s ease both;
    }

    .section{
      padding:24px 24px 24px 34px;
      border-bottom:1px solid var(--line);
      opacity:0;
      transform:translateY(10px);
      animation:riseIn .45s ease forwards;
      position:relative;
      overflow:hidden;
    }

    .section:last-child{ border-bottom:none; }

    .section::before{
      content:"";
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:9px;
      background:transparent;
      border-radius:0 5px 5px 0;
      z-index:1;
    }

    .section::after{
      content:"";
      position:absolute;
      left:9px;
      top:0;
      bottom:0;
      width:24px;
      background:linear-gradient(90deg, var(--section-tint), rgba(255,255,255,0));
      pointer-events:none;
      z-index:0;
    }

    .section > *{
      position:relative;
      z-index:2;
    }

    .section:nth-of-type(1){
      --section-tint: rgba(76,141,171,.20);
      animation-delay:.20s;
      background:linear-gradient(180deg, #fcfeff 0%, #e8f5ff 100%);
      box-shadow:inset 0 0 0 1px rgba(161,202,225,.30);
    }
    .section:nth-of-type(1)::before{ background:linear-gradient(180deg, #3f7f9f, #58a9a0); }
    .section:nth-of-type(1) .tag{
      background:#e5f3fc;
      border-color:#b2d2e6;
      color:#295f7d;
    }

    .section:nth-of-type(2){
      --section-tint: rgba(79,143,176,.18);
      animation-delay:.28s;
      background:linear-gradient(180deg, #fcffff 0%, #e7f4ff 100%);
      box-shadow:inset 0 0 0 1px rgba(155,205,224,.30);
    }
    .section:nth-of-type(2)::before{ background:linear-gradient(180deg, #4687a8, #5eb7ab); }
    .section:nth-of-type(2) .tag{
      background:#e1f4fb;
      border-color:#b1d8e5;
      color:#2a667f;
    }

    .section:nth-of-type(3){
      --section-tint: rgba(95,155,143,.22);
      animation-delay:.36s;
      background:linear-gradient(180deg, #fbfffd 0%, #e4f6ee 100%);
      box-shadow:inset 0 0 0 1px rgba(166,213,192,.32);
    }
    .section:nth-of-type(3)::before{ background:linear-gradient(180deg, #5a988b, #7cb598); }
    .section:nth-of-type(3) .tag{
      background:#e3f5ee;
      border-color:#afd8c4;
      color:#326c5f;
    }

    .section:nth-of-type(4){
      --section-tint: rgba(111,152,179,.20);
      animation-delay:.44s;
      background:linear-gradient(180deg, #feffff 0%, #e7f1fb 100%);
      box-shadow:inset 0 0 0 1px rgba(169,197,220,.32);
    }
    .section:nth-of-type(4)::before{ background:linear-gradient(180deg, #648fad, #90afc2); }
    .section:nth-of-type(4) .tag{
      background:#e4effa;
      border-color:#b7d0e4;
      color:#395f7a;
    }

    .section:nth-of-type(5){
      --section-tint: rgba(183,125,93,.22);
      animation-delay:.52s;
      background:linear-gradient(180deg, #fffdfb 0%, #ffece0 100%);
      box-shadow:inset 0 0 0 1px rgba(224,177,146,.34);
    }
    .section:nth-of-type(5)::before{ background:linear-gradient(180deg, #b17352, #d69268); }
    .section:nth-of-type(5) .tag{
      background:#ffece0;
      border-color:#e4bfa3;
      color:#85573e;
    }

    .section h2{
      margin:0;
      font-family:"Literata", Georgia, serif;
      font-size:1.48rem;
      line-height:1.25;
      color:#22384a;
      letter-spacing:.12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .section h2 .tag{
      font-family:"Source Sans 3", Arial, sans-serif;
      font-size:.78rem;
      font-weight:700;
      color:#4f6d81;
      border:1px solid #c7d9e4;
      border-radius:999px;
      padding:5px 10px;
      background:rgba(245,251,255,.95);
    }

    .lead{
      margin:10px 0 0;
      font-size:1.03rem;
      color:var(--muted);
      max-width:78ch;
    }

    .row{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:16px;
      margin-top:14px;
    }

    .field{ display:flex; flex-direction:column; gap:8px; }

    .field label{
      font-size:.95rem;
      font-weight:700;
      color:#50697b;
      letter-spacing:.1px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea{
      width:100%;
      border:1px solid var(--line-strong);
      border-radius:13px;
      padding:13px 14px;
      background:#ffffff;
      color:var(--text);
      font:inherit;
      font-size:1rem;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, transform .12s ease, background .15s ease;
    }

    input::placeholder,
    textarea::placeholder{ color:#8d9faf; }

    textarea{ min-height:108px; resize:vertical; line-height:1.5; }

    input:focus,
    textarea:focus,
    select:focus{
      border-color:#4f91b2;
      box-shadow:var(--focus);
      transform:translateY(-1px);
      background:#fff;
    }

    input[type="radio"],
    input[type="checkbox"]{ accent-color:var(--brand); }

    .invalid input,
    .invalid textarea,
    .invalid select{
      border-color:rgba(177,77,77,.72) !important;
      box-shadow:0 0 0 4px rgba(177,77,77,.12) !important;
    }

    .msg{
      margin-top:1px;
      font-size:.84rem;
      color:var(--muted2);
    }

    .msg.err{ color:var(--danger); }

    .sep{
      height:1px;
      margin:18px 0;
      background:linear-gradient(90deg, transparent, #cfe0ea 14%, #cfe0ea 86%, transparent);
    }

    .choice-group{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:12px;
    }

    .choice{
      border:1px solid var(--line);
      border-radius:15px;
      padding:13px;
      display:flex;
      gap:11px;
      align-items:flex-start;
      background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(247,252,255,.96));
      cursor:pointer;
      user-select:none;
      transition:all .15s ease;
    }

    .choice:hover{
      transform:translateY(-2px);
      border-color:#bfd4e1;
      box-shadow:0 12px 18px rgba(40,74,98,.09);
      background:linear-gradient(180deg, #ffffff, #f5fbff);
    }

    .choice input{ margin-top:4px; }

    .choice .ct{ display:flex; flex-direction:column; gap:3px; }

    .choice .ct strong{
      font-size:.97rem;
      color:#2f4a5d;
      letter-spacing:.08px;
    }

    .choice .ct span{
      font-size:.87rem;
      color:var(--muted);
      line-height:1.4;
    }

    .note{
      margin-top:14px;
      border:1px solid #d4e2eb;
      border-radius:15px;
      padding:13px 14px;
      background:linear-gradient(180deg, rgba(245,251,255,.95), rgba(252,247,242,.95));
      color:#607889;
      font-size:.9rem;
      box-shadow:0 8px 16px rgba(40,74,98,.07);
    }

    .note strong{ color:#36546a; }

    .note.note-center{
      text-align:center;
      max-width:74ch;
      margin-left:auto;
      margin-right:auto;
    }

    .preview{
      margin-top:12px;
      border:1px dashed #bdd2df;
      border-radius:15px;
      padding:13px 14px;
      background:linear-gradient(135deg, rgba(247,252,255,.95), rgba(251,247,242,.9));
    }

    .mono{
      font-family:"IBM Plex Mono", "Consolas", monospace;
      font-size:1.02rem;
      font-weight:700;
      letter-spacing:.5px;
      color:#2c495d;
    }

    .actions{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      z-index:25;
      padding:10px 16px 14px;
      border-top:1px solid rgba(155,183,201,.34);
      background:linear-gradient(180deg, rgba(243,247,251,0), rgba(243,247,251,.94) 32%, rgba(238,245,250,.98));
      backdrop-filter:blur(10px);
    }

    .actions-inner{
      max-width:1280px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .summary{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:.9rem;
    }

    .summary .kpi{
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 11px;
      display:flex;
      gap:8px;
      align-items:center;
      background:rgba(255,255,255,.92);
      color:#557082;
      font-variant-numeric:tabular-nums;
      box-shadow:0 5px 12px rgba(40,74,98,.07);
    }

    .summary .kpi strong{ color:#2f4b60; }

    .btns{ display:flex; gap:10px; align-items:center; }

    button{
      border:1px solid #bfd2df;
      border-radius:13px;
      padding:11px 15px;
      font:inherit;
      font-weight:700;
      cursor:pointer;
      color:#335266;
      background:linear-gradient(180deg, #ffffff, #f2f8fc);
      transition:all .15s ease;
    }

    button:hover{
      transform:translateY(-1px);
      border-color:#aac2d3;
      box-shadow:0 12px 18px rgba(40,74,98,.10);
    }

    .primary{
      border-color:#3d83a4;
      background:linear-gradient(135deg, #2f7f9f, #45a79b);
      color:#f4fbff;
      box-shadow:0 14px 22px rgba(46,124,156,.24);
    }

    .primary:hover{
      background:linear-gradient(135deg, #2b7490, #3f9c90);
    }

    .ghost{ background:rgba(255,255,255,.84); }

    .footer{
      margin-top:16px;
      padding:14px 8px 0;
      font-size:.92rem;
      color:var(--muted);
      text-align:center;
    }

    @keyframes riseIn{
      from{ opacity:0; transform:translateY(14px); }
      to{ opacity:1; transform:translateY(0); }
    }

    @keyframes drift{
      0%,100%{ transform:translate3d(0,0,0); }
      50%{ transform:translate3d(0,-6px,0); }
    }

    @media (max-width:1080px){
      .wrap{ margin-top:22px; }
      .status{ align-items:flex-start; width:100%; }
      .statusline{ justify-content:flex-start; }
      .nav{ position:relative; top:0; }
      .actions-inner{ align-items:flex-start; }
    }

    @media (max-width:780px){
      body{ font-size:16px; }
      .wrap{ padding:0 14px; margin-bottom:195px; }
      h1{ font-size:1.68rem; }
      .subtitle{ font-size:.97rem; }
      .section{ padding:18px 18px 18px 26px; }
      .section h2{ font-size:1.3rem; }
      .row{ grid-template-columns:1fr; gap:12px; }
      .btns{ width:100%; }
      .btns button{ flex:1; }
    }

    @media print{
      .nav,
      .actions{ display:none !important; }

      body{ background:#fff; color:#000; }
      body::before,
      .hero::before,
      .hero::after{ display:none; }

      .hero,
      .card,
      .section,
      .note,
      .preview,
      .choice,
      .pill,
      .summary .kpi,
      input,
      textarea,
      select{
        box-shadow:none !important;
        border-color:#d4d4d4 !important;
        background:#fff !important;
        color:#111 !important;
      }
    }

    @media (prefers-reduced-motion: reduce){
      *{
        animation:none !important;
        transition:none !important;
        scroll-behavior:auto !important;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="hero" id="top">
      <div class="hero-top">
        <div class="brand">
          <div class="mark" aria-hidden="true">
            <!-- icono simple (árbol/vida) -->
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
              <path d="M12 2c-2.3 2.7-3.6 4.9-3.6 7.2 0 1.5.6 2.9 1.7 4.1-2.6-.1-4.6-1.1-6.1-3.3-.2 4.6 3 8.6 8 9.2V22h2v-2.8c5-.6 8.2-4.6 8-9.2-1.5 2.2-3.5 3.2-6.1 3.3 1.1-1.2 1.7-2.6 1.7-4.1C15.6 6.9 14.3 4.7 12 2Z" fill="rgba(11,18,32,.9)"/>
            </svg>
          </div>
          <div>
            <h1>Cuestionario clínico · Configuración</h1>
            <p class="subtitle">
              Esto nos sirve para que el sistema “piense” como usted: DV OMS, diagnóstico refractivo e imágenes.
              <br><span style="color:rgba(234,240,255,.92)">Toma ~8–12 min</span> si ya tiene criterios claros.
            </p>
          </div>
        </div>

        <div class="status" aria-live="polite">
          <div class="progress" title="Progreso">
            <div id="progressFill"></div>
          </div>
          <div class="statusline">
            <span class="pill">Completado: <strong id="doneCount">0</strong>/<strong id="reqCount">0</strong></span>
            <span class="pill">Sección: <strong id="activeSection">1</strong>/5</span>
            <span class="pill" id="autosavePill">Auto-guardado: <strong id="autosaveState">Listo</strong></span>
          </div>
        </div>
      </div>
    </header>

    <form id="form" action="https://formsubmit.co/julian110101@gmail.com" method="POST" novalidate>
      <input type="hidden" name="_subject" value="Respuestas cuestionario clinico VisionCeiba" />
      <input type="hidden" name="_template" value="table" />
      <input type="hidden" name="_captcha" value="false" />

      <div class="grid">
        <!-- NAV -->
        <aside class="nav" aria-label="Navegación de secciones">
          <div class="nav-head">
            <p class="nav-title">Ruta rápida</p>
          </div>
          <ul class="nav-list">
            <li><a href="#s1" data-nav="s1" class="active"><span class="dot" id="dot-s1"></span><span>1) DV OMS</span><small id="mini-s1">0%</small></a></li>
            <li><a href="#s2" data-nav="s2"><span class="dot" id="dot-s2"></span><span>2) Dx Refractivo</span><small id="mini-s2">0%</small></a></li>
            <li><a href="#s3" data-nav="s3"><span class="dot" id="dot-s3"></span><span>3) Imágenes</span><small id="mini-s3">0%</small></a></li>
            <li><a href="#s4" data-nav="s4"><span class="dot" id="dot-s4"></span><span>4) Integridad/Folio</span><small id="mini-s4">0%</small></a></li>
            <li><a href="#s5" data-nav="s5"><span class="dot" id="dot-s5"></span><span>5) Casos clínicos</span><small id="mini-s5">0%</small></a></li>
          </ul>
        </aside>

        <!-- CONTENT -->
        <main class="card">

          <!-- SECTION 1 -->
          <section class="section" id="s1" data-section>
            <h2>1) Clasificación “DV OMS” <span class="tag">Deficit Visual</span></h2>
            <p class="lead">
              Responda como si estuviera enseñándole al sistema su criterio. Si hay excepciones, escríbalas: nos ahorra retrabajo.
            </p>

            <div class="sep"></div>

            <p class="lead" style="margin-top:0"><strong>1.1</strong> La clasificación DV se basa en:</p>
            <div class="choice-group" role="radiogroup" aria-label="Base DV">
              <label class="choice">
                <input type="radio" name="dv_base" value="Mejor ojo" required>
                <span class="ct"><strong>Mejor ojo</strong><span>DV final según el ojo con mejor AV.</span></span>
              </label>
              <label class="choice">
                <input type="radio" name="dv_base" value="Peor ojo">
                <span class="ct"><strong>Peor ojo</strong><span>Prioriza el peor escenario funcional.</span></span>
              </label>
              <label class="choice">
                <input type="radio" name="dv_base" value="Ambos">
                <span class="ct"><strong>Ambos</strong><span>Regla combinada (explique abajo).</span></span>
              </label>
            </div>

            <div class="row">
              <div class="field" data-depends-on="dv_base" data-show-when="Ambos">
                <label for="dv_base_ambos_detalle">Si es “Ambos”, explique el criterio</label>
                <input id="dv_base_ambos_detalle" name="dv_base_ambos_detalle" type="text" maxlength="240"
                  placeholder="Ej: Mejor ojo para DV final, peor ojo como nota secundaria" />
                <div class="msg">Tip: describa en una frase la regla que usaría en consultorio.</div>
              </div>
            </div>

            <div class="sep"></div>

            <p class="lead" style="margin-top:0"><strong>1.2</strong> ¿Qué AV se usa para clasificar DV?</p>
            <div class="choice-group" role="radiogroup" aria-label="Fuente AV DV">
              <label class="choice">
                <input type="radio" name="dv_av_fuente" value="Sin estenopeico siempre" required>
                <span class="ct"><strong>Sin estenopeico (siempre)</strong><span>Usa AV base, sin pinhole.</span></span>
              </label>
              <label class="choice">
                <input type="radio" name="dv_av_fuente" value="Con estenopeico si existe">
                <span class="ct"><strong>Con estenopeico si existe</strong><span>Si hay estenopeico, toma ese valor.</span></span>
              </label>
              <label class="choice">
                <input type="radio" name="dv_av_fuente" value="Otro">
                <span class="ct"><strong>Otro criterio</strong><span>Ej: solo si mejora “X” líneas.</span></span>
              </label>
            </div>

            <div class="row">
              <div class="field" data-depends-on="dv_av_fuente" data-show-when="Otro">
                <label for="dv_av_fuente_otro">Si eligió “Otro”, describa la regla</label>
                <input id="dv_av_fuente_otro" name="dv_av_fuente_otro" type="text" maxlength="240"
                  placeholder="Ej: Usar estenopeico solo si mejora al menos 2 líneas" />
                <div class="msg">Mientras más exacto, menos dudas durante la implementación.</div>
              </div>
            </div>

            <div class="sep"></div>

            <p class="lead" style="margin-top:0"><strong>1.3</strong> Límites exactos para DV (0 a 5)</p>
            <div class="row">
              <div class="field">
                <label for="dv_0">DV 0</label>
                <input id="dv_0" name="dv_0" type="text" required maxlength="120" placeholder="Ej: Sin DV (>= 20/60)" />
              </div>
              <div class="field">
                <label for="dv_1">DV 1</label>
                <input id="dv_1" name="dv_1" type="text" required maxlength="120" placeholder="Ej: <20/60 y >=20/200" />
              </div>
              <div class="field">
                <label for="dv_2">DV 2</label>
                <input id="dv_2" name="dv_2" type="text" required maxlength="120" placeholder="Ej: <20/200 y >=20/400" />
              </div>
              <div class="field">
                <label for="dv_3">DV 3</label>
                <input id="dv_3" name="dv_3" type="text" required maxlength="120" placeholder="Ej: <20/400 y >=20/1200" />
              </div>
              <div class="field">
                <label for="dv_4">DV 4</label>
                <input id="dv_4" name="dv_4" type="text" required maxlength="120" placeholder="Ej: <20/1200 o PL" />
              </div>
              <div class="field">
                <label for="dv_5">DV 5</label>
                <input id="dv_5" name="dv_5" type="text" required maxlength="120" placeholder="Ej: NPL" />
              </div>
            </div>

            <div class="field" style="margin-top:12px">
              <label for="dv_notas">Notas DV (opcional)</label>
              <textarea id="dv_notas" name="dv_notas" placeholder="Ej: Consideraciones especiales, excepciones o notas clínicas."></textarea>
            </div>

            <div class="note">
              <strong>Idea clave:</strong> piense en esto como “entrenar” al sistema. Cualquier excepción que suele aplicar en su práctica vale oro.
            </div>
          </section>

          <!-- SECTION 2 -->
          <section class="section" id="s2" data-section>
            <h2>2) Diagnóstico refractivo automático <span class="tag">Miopía · Hipermetropía · Astigmatismo</span></h2>
            <p class="lead">
              Aquí definimos reglas claras para que la salida se vea profesional y consistente (como si la escribiera usted).
            </p>

            <div class="row">
              <div class="field">
                <label for="emetropia_rango">2.1 Definición exacta de emetropía</label>
                <input id="emetropia_rango" name="emetropia_rango" type="text" required maxlength="160" placeholder="Ej: ESF entre -0.50 y +0.50" />
              </div>
              <div class="field">
                <label for="miopia_regla">Regla para Miopía</label>
                <input id="miopia_regla" name="miopia_regla" type="text" required maxlength="160" placeholder="Ej: ESF < -0.50" />
              </div>
              <div class="field">
                <label for="hipermetropia_regla">Regla para Hipermetropía</label>
                <input id="hipermetropia_regla" name="hipermetropia_regla" type="text" required maxlength="160" placeholder="Ej: ESF > +0.50" />
              </div>
              <div class="field">
                <label for="astigmatismo_regla">Regla para Astigmatismo</label>
                <input id="astigmatismo_regla" name="astigmatismo_regla" type="text" required maxlength="160" placeholder="Ej: |CIL| >= 0.75" />
              </div>
            </div>

            <div class="sep"></div>

            <p class="lead" style="margin-top:0"><strong>2.2</strong> La clasificación se basa en:</p>
            <div class="choice-group" role="radiogroup" aria-label="Base refracción">
              <label class="choice">
                <input type="radio" name="refraccion_base" value="Esfera (ESF)" required>
                <span class="ct"><strong>Esfera (ESF)</strong><span>Más directa y simple.</span></span>
              </label>
              <label class="choice">
                <input type="radio" name="refraccion_base" value="Equivalente esferico (EE)">
                <span class="ct"><strong>Equivalente esférico (EE)</strong><span>Útil para decisiones globales.</span></span>
              </label>
              <label class="choice">
                <input type="radio" name="refraccion_base" value="Otro">
                <span class="ct"><strong>Otro</strong><span>Regla combinada (explique).</span></span>
              </label>
            </div>

            <div class="row">
              <div class="field" data-depends-on="refraccion_base" data-show-when="Otro">
                <label for="refraccion_base_otro">Si eligió “Otro”, explique</label>
                <input id="refraccion_base_otro" name="refraccion_base_otro" type="text" maxlength="240"
                  placeholder="Ej: ESF para tipo y CIL para subtipo" />
                <div class="msg">La meta: una regla que cualquiera del equipo pueda implementar sin interpretar.</div>
              </div>
            </div>

            <div class="field" style="margin-top:12px">
              <label for="refraccion_combinacion">2.3 Si hay combinación, formato de salida deseado</label>
              <input id="refraccion_combinacion" name="refraccion_combinacion" type="text" required maxlength="160"
                placeholder='Ej: "Miopía con astigmatismo"' />
              <div class="msg">Tip: escriba la frase tal cual quiere verla en la nota / reporte.</div>
            </div>

            <div class="field" style="margin-top:12px">
              <label for="refraccion_notas">Notas refracción (opcional)</label>
              <textarea id="refraccion_notas" name="refraccion_notas" placeholder="Ej: cómo manejar casos borderline o mixtos."></textarea>
            </div>
          </section>

          <!-- SECTION 3 -->
          <section class="section" id="s3" data-section>
            <h2>3) Imágenes <span class="tag">OD/OI · Segmento anterior · Fondo</span></h2>
            <p class="lead">
              Definimos el comportamiento para evitar límites artificiales (y mantener orden cuando hay varias tomas).
            </p>

            <p class="lead" style="margin-top:12px"><strong>3.1</strong> ¿Permitir múltiples imágenes por rubro y ojo?</p>
            <div class="choice-group" role="radiogroup" aria-label="Imágenes múltiples">
              <label class="choice">
                <input type="radio" name="imagenes_multiples" value="Si" required>
                <span class="ct"><strong>Sí</strong><span>Ej: 3 fotos de Fondo de Ojo OD.</span></span>
              </label>
              <label class="choice">
                <input type="radio" name="imagenes_multiples" value="No">
                <span class="ct"><strong>No</strong><span>Solo 1 por rubro y ojo.</span></span>
              </label>
            </div>

            <div class="field" style="margin-top:12px">
              <label for="imagenes_notas">Notas imágenes (opcional)</label>
              <textarea id="imagenes_notas" name="imagenes_notas" placeholder="Ej: cómo nombrar, si hay prioridad por calidad, etc."></textarea>
            </div>
          </section>

          <!-- SECTION 4 -->
          <section class="section" id="s4" data-section>
            <h2>4) Integridad y folio interno <span class="tag">Duplicados · Folio</span></h2>
            <p class="lead">
              Aquí evitamos pacientes duplicados y definimos un folio claro. Piense en “reglas de seguridad” del sistema.
            </p>

            <div class="sep"></div>

            <p class="lead" style="margin-top:0"><strong>4.1</strong> Regla exacta para rechazar duplicado</p>
            <div class="choice-group" role="group" aria-label="Reglas duplicado">
              <label class="choice">
                <input type="checkbox" name="dup_reglas[]" value="Telefono exacto (solo digitos)">
                <span class="ct"><strong>Teléfono</strong><span>Comparar solo dígitos.</span></span>
              </label>
              <label class="choice">
                <input type="checkbox" name="dup_reglas[]" value="Correo exacto en minusculas">
                <span class="ct"><strong>Correo</strong><span>Normalizar a minúsculas.</span></span>
              </label>
              <label class="choice">
                <input type="checkbox" name="dup_reglas[]" value="Nombre completo normalizado + fecha de nacimiento exacta">
                <span class="ct"><strong>Nombre + FN</strong><span>Nombre normalizado + fecha exacta.</span></span>
              </label>
              <label class="choice">
                <input type="checkbox" name="dup_reglas[]" value="Nombre completo normalizado + fecha de nacimiento + sexo">
                <span class="ct"><strong>Nombre + FN + sexo</strong><span>Más estricto para evitar homónimos.</span></span>
              </label>
            </div>

            <div class="field" style="margin-top:12px">
              <label for="dup_regla_final">Regla final exacta (obligatoria)</label>
              <textarea id="dup_regla_final" name="dup_regla_final" required
                placeholder="Escriba UNA regla final clara para el rechazo de duplicados."></textarea>
              <div class="msg" id="dupRuleMsg">“Nombre completo normalizado” = sin acentos, sin dobles espacios, mayúsculas/minúsculas indiferentes.</div>
            </div>

            <div class="sep"></div>

            <p class="lead" style="margin-top:0"><strong>4.2</strong> Formato del folio interno</p>
            <div class="row">
              <div class="field">
                <label for="folio_prefijo">Prefijo</label>
                <input id="folio_prefijo" name="folio_prefijo" type="text" required maxlength="16" placeholder="Ej: VC-P-" />
              </div>
              <div class="field">
                <label for="folio_digitos">Cantidad de dígitos</label>
                <input id="folio_digitos" name="folio_digitos" type="number" required min="1" max="10" value="4" />
              </div>
              <div class="field">
                <label for="folio_inicio">Valor inicial</label>
                <input id="folio_inicio" name="folio_inicio" type="number" required min="1" value="1" />
              </div>
            </div>

            <div class="preview" aria-live="polite">
              <div class="msg"><strong style="color:var(--text)">Vista previa:</strong> así lo verá el personal</div>
              <div id="folio_preview" class="mono">VC-P-0001</div>
            </div>

            <div class="choice-group" role="radiogroup" aria-label="Reinicio de folio" style="margin-top:12px">
              <label class="choice">
                <input type="radio" name="folio_reinicio" value="Nunca" required>
                <span class="ct"><strong>Nunca reinicia</strong><span>Secuencia continua.</span></span>
              </label>
              <label class="choice">
                <input type="radio" name="folio_reinicio" value="Anual">
                <span class="ct"><strong>Reinicia anual</strong><span>Nuevo conteo cada año.</span></span>
              </label>
            </div>
          </section>

          <!-- SECTION 5 -->
          <section class="section" id="s5" data-section>
            <h2>5) Casos de validación clínica <span class="tag">Prueba de fuego</span></h2>
            <p class="lead">
              Estos casos son para validar que la automatización coincide con lo esperado (DV + Dx + alertas).
            </p>

            <div class="sep"></div>
            <h2 style="font-size:1.08rem;margin:0 0 10px;">Caso A · DV (obligatorio) <span class="tag">Ejemplo real</span></h2>
            <div class="row">
              <div class="field"><label for="ca_av_od">AV OD</label><input id="ca_av_od" name="ca_av_od" type="text" required maxlength="40" placeholder="Ej: 20/70" /></div>
              <div class="field"><label for="ca_av_oi">AV OI</label><input id="ca_av_oi" name="ca_av_oi" type="text" required maxlength="40" placeholder="Ej: 20/100" /></div>
              <div class="field"><label for="ca_est_od">Estenopeico OD (si aplica)</label><input id="ca_est_od" name="ca_est_od" type="text" maxlength="40" placeholder='Ej: "No" o "Sí, 20/50"' /></div>
              <div class="field"><label for="ca_est_oi">Estenopeico OI (si aplica)</label><input id="ca_est_oi" name="ca_est_oi" type="text" maxlength="40" placeholder='Ej: "No" o "Sí, 20/40"' /></div>
              <div class="field"><label for="ca_dv_esperado">Salida esperada DV</label><input id="ca_dv_esperado" name="ca_dv_esperado" type="text" required maxlength="40" placeholder="Ej: DV 2" /></div>
            </div>

            <div class="sep"></div>
            <h2 style="font-size:1.08rem;margin:0 0 10px;">Caso B · Refracción (obligatorio)</h2>
            <div class="row">
              <div class="field"><label for="cb_ref_od">Refracción OD (ESF/CIL/EJE)</label><input id="cb_ref_od" name="cb_ref_od" type="text" required maxlength="80" placeholder="Ej: -2.00 / -1.00 x 10" /></div>
              <div class="field"><label for="cb_ref_oi">Refracción OI (ESF/CIL/EJE)</label><input id="cb_ref_oi" name="cb_ref_oi" type="text" required maxlength="80" placeholder="Ej: +0.50 / -0.75 x 90" /></div>
              <div class="field"><label for="cb_dx_od_esperado">Salida esperada Dx OD</label><input id="cb_dx_od_esperado" name="cb_dx_od_esperado" type="text" required maxlength="100" placeholder="Ej: Miopía con astigmatismo" /></div>
              <div class="field"><label for="cb_dx_oi_esperado">Salida esperada Dx OI</label><input id="cb_dx_oi_esperado" name="cb_dx_oi_esperado" type="text" required maxlength="100" placeholder="Ej: Hipermetropía leve" /></div>
            </div>

            <div class="sep"></div>
            <h2 style="font-size:1.08rem;margin:0 0 10px;">Caso C · Alertas (obligatorio)</h2>
            <div class="row">
              <div class="field"><label for="cc_pio_od">PIO OD</label><input id="cc_pio_od" name="cc_pio_od" type="number" required min="0" max="80" placeholder="Ej: 18" /></div>
              <div class="field"><label for="cc_pio_oi">PIO OI</label><input id="cc_pio_oi" name="cc_pio_oi" type="number" required min="0" max="80" placeholder="Ej: 26" /></div>
              <div class="field"><label for="cc_kp_od">Kp OD</label><input id="cc_kp_od" name="cc_kp_od" type="text" required maxlength="40" placeholder="Ej: 44.00" /></div>
              <div class="field"><label for="cc_kp_oi">Kp OI</label><input id="cc_kp_oi" name="cc_kp_oi" type="text" required maxlength="40" placeholder="Ej: 46.25" /></div>
              <div class="field"><label for="cc_ret_od">Reflejo retina OD</label><input id="cc_ret_od" name="cc_ret_od" type="text" required maxlength="40" placeholder="Ej: Rojo" /></div>
              <div class="field"><label for="cc_ret_oi">Reflejo retina OI</label><input id="cc_ret_oi" name="cc_ret_oi" type="text" required maxlength="40" placeholder="Ej: Amarillo" /></div>
              <div class="field"><label for="cc_alerta_pio_od_esperada">Salida esperada alerta PIO OD</label><input id="cc_alerta_pio_od_esperada" name="cc_alerta_pio_od_esperada" type="text" required maxlength="80" placeholder="Ej: Normal" /></div>
              <div class="field"><label for="cc_alerta_pio_oi_esperada">Salida esperada alerta PIO OI</label><input id="cc_alerta_pio_oi_esperada" name="cc_alerta_pio_oi_esperada" type="text" required maxlength="80" placeholder="Ej: HTO" /></div>
              <div class="field"><label for="cc_alerta_kp_od_esperada">Salida esperada alerta Kp OD</label><input id="cc_alerta_kp_od_esperada" name="cc_alerta_kp_od_esperada" type="text" required maxlength="80" placeholder="Ej: Normal" /></div>
              <div class="field"><label for="cc_alerta_kp_oi_esperada">Salida esperada alerta Kp OI</label><input id="cc_alerta_kp_oi_esperada" name="cc_alerta_kp_oi_esperada" type="text" required maxlength="80" placeholder="Ej: Sospecha ectasia" /></div>
              <div class="field"><label for="cc_alerta_ret_od_esperada">Salida esperada alerta retina OD</label><input id="cc_alerta_ret_od_esperada" name="cc_alerta_ret_od_esperada" type="text" required maxlength="80" placeholder="Ej: Normal (Rojo)" /></div>
              <div class="field"><label for="cc_alerta_ret_oi_esperada">Salida esperada alerta retina OI</label><input id="cc_alerta_ret_oi_esperada" name="cc_alerta_ret_oi_esperada" type="text" required maxlength="80" placeholder="Ej: Anormal (Amarillo)" /></div>
            </div>

            <div class="sep"></div>
            <h2 style="font-size:1.08rem;margin:0 0 10px;">Caso D · Combinado (opcional)</h2>
            <div class="row">
              <div class="field">
                <label for="cd_entrada">Entrada completa</label>
                <textarea id="cd_entrada" name="cd_entrada" placeholder="AV OD/OI, estenopeico OD/OI, refracción OD/OI, PIO OD/OI, Kp OD/OI, retina OD/OI"></textarea>
              </div>
              <div class="field">
                <label for="cd_salida">Salida esperada completa</label>
                <textarea id="cd_salida" name="cd_salida" placeholder="DV, Dx OD, Dx OI, alertas"></textarea>
              </div>
            </div>

            <div class="note note-center">
              <strong>Tip rápido:</strong> si algún criterio cambia “según contexto”, escríbalo como excepción (p. ej. “en pediatría…”).
            </div>
          </section>
        </main>
      </div>

      <p class="footer">
        Gracias, Doc. Con esto dejamos la automatización alineada con su criterio clínico, y evitamos ajustes después.
      </p>

      <div class="actions">
        <div class="actions-inner">
          <div class="summary" aria-live="polite">
            <span class="kpi">Campos obligatorios: <strong id="kpiReq">0</strong></span>
            <span class="kpi">Completados: <strong id="kpiDone">0</strong></span>
            <span class="kpi">Pendientes: <strong id="kpiLeft">0</strong></span>
          </div>
          <div class="btns">
            <button type="button" class="ghost" id="btnTop" title="Subir al inicio">↑ Inicio</button>
            <button type="button" id="btnNext" title="Ir a la siguiente sección">Siguiente sección →</button>
            <button type="submit" class="primary" id="btnSubmit">Enviar respuestas</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
    (function(){
      const form = document.getElementById('form');

      // --- Folio preview ---
      const prefixEl = document.getElementById('folio_prefijo');
      const digitsEl = document.getElementById('folio_digitos');
      const startEl  = document.getElementById('folio_inicio');
      const previewEl= document.getElementById('folio_preview');

      function clampInt(value, fallback, min, max){
        const n = Number.parseInt(String(value), 10);
        if (Number.isNaN(n)) return fallback;
        return Math.min(max, Math.max(min, n));
      }
      function renderPreview(){
        if(!prefixEl || !digitsEl || !startEl || !previewEl) return;
        const prefix = (prefixEl.value || '').trim();
        const digits = clampInt(digitsEl.value, 4, 1, 10);
        const start  = clampInt(startEl.value, 1, 1, 999999999);
        previewEl.textContent = `${prefix}${String(start).padStart(digits, '0')}`;
      }
      [prefixEl, digitsEl, startEl].forEach(el => el && el.addEventListener('input', renderPreview));
      renderPreview();

      // --- Progressive disclosure (show/hide dependent fields) ---
      const depFields = Array.from(document.querySelectorAll('[data-depends-on]'));
      function getRadioValue(name){
        const el = document.querySelector(`input[type="radio"][name="${CSS.escape(name)}"]:checked`);
        return el ? el.value : '';
      }
      function updateDeps(){
        depFields.forEach(f => {
          const name = f.getAttribute('data-depends-on');
          const showWhen = f.getAttribute('data-show-when');
          const v = getRadioValue(name);
          const show = v === showWhen;
          f.style.display = show ? '' : 'none';
          // Si se oculta, limpiamos y quitamos error visual
          if(!show){
            const inputs = f.querySelectorAll('input, textarea, select');
            inputs.forEach(i => {
              i.value = '';
              i.removeAttribute('aria-invalid');
              f.classList.remove('invalid');
              const msg = f.querySelector('.msg.err');
              if(msg) msg.remove();
            });
          }
        });
      }
      form.addEventListener('change', updateDeps);
      updateDeps();

      // --- Autosave local (reduce ansiedad: "no se me va a borrar") ---
      const autosaveKey = 'vc_config_questionnaire_v1';
      const autosaveVersion = 2;
      const autosaveState = document.getElementById('autosaveState');
      const autosavePill = document.getElementById('autosavePill');
      let isSubmitting = false;

      function setAutosave(label, ok=true){
        if(!autosaveState) return;
        autosaveState.textContent = label;
        if(autosavePill){
          autosavePill.style.borderColor = ok ? 'rgba(110,169,140,.38)' : 'rgba(184,74,74,.36)';
        }
      }

      function formatTime(ts){
        try{
          return new Date(ts).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
        }catch(_){
          return '';
        }
      }

      function serializeForm(){
        const fd = new FormData(form);
        const obj = {};
        for(const [k,v] of fd.entries()){
          // dup_reglas[] -> array
          if(k.endsWith('[]')){
            obj[k] = obj[k] || [];
            obj[k].push(v);
          }else{
            obj[k] = v;
          }
        }
        return obj;
      }

      function persistAutosave(){
        try{
          const payload = {
            v: autosaveVersion,
            t: Date.now(),
            data: serializeForm(),
          };
          localStorage.setItem(autosaveKey, JSON.stringify(payload));
          const hhmm = formatTime(payload.t);
          setAutosave(hhmm ? `Guardado ${hhmm}` : 'Guardado', true);
          return true;
        }catch(e){
          setAutosave('Error', false);
          return false;
        }
      }

      function restoreForm(){
        try{
          const raw = localStorage.getItem(autosaveKey);
          if(!raw) return;
          const parsed = JSON.parse(raw);
          const data = (parsed && typeof parsed === 'object' && parsed.data && typeof parsed.data === 'object')
            ? parsed.data
            : parsed;
          const savedAt = (parsed && typeof parsed === 'object' && typeof parsed.t === 'number')
            ? parsed.t
            : null;
          if(!data || typeof data !== 'object') return;

          // set simple fields
          Object.keys(data).forEach(k => {
            const val = data[k];

            // arrays (checkbox lists)
            if(Array.isArray(val)){
              val.forEach(item => {
                const cb = form.querySelector(`input[type="checkbox"][name="${CSS.escape(k)}"][value="${CSS.escape(item)}"]`);
                if(cb) cb.checked = true;
              });
              return;
            }

            // radios
            const radios = form.querySelectorAll(`input[type="radio"][name="${CSS.escape(k)}"]`);
            if(radios && radios.length){
              radios.forEach(r => r.checked = (r.value === val));
              return;
            }

            // normal inputs/textarea
            const el = form.querySelector(`[name="${CSS.escape(k)}"]`);
            if(el) el.value = val;
          });

          updateDeps();
          renderPreview();
          const hhmm = savedAt ? formatTime(savedAt) : '';
          setAutosave(hhmm ? `Restaurado ${hhmm}` : 'Restaurado', true);
        }catch(e){
          setAutosave('Error', false);
        }
      }

      let autosaveTimer = null;
      function scheduleAutosave(){
        setAutosave('Guardando…', true);
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(() => {
          persistAutosave();
        }, 350);
      }

      function flushAutosave(){
        if(isSubmitting) return;
        if(autosaveTimer){
          clearTimeout(autosaveTimer);
          autosaveTimer = null;
        }
        persistAutosave();
      }

      form.addEventListener('input', scheduleAutosave);
      form.addEventListener('change', scheduleAutosave);
      window.addEventListener('pagehide', flushAutosave);
      window.addEventListener('beforeunload', flushAutosave);
      document.addEventListener('visibilitychange', () => {
        if(document.visibilityState === 'hidden') flushAutosave();
      });
      restoreForm();

      // --- Required progress + per-section completion ---
      const reqEls = Array.from(form.querySelectorAll('[required]'))
        .filter(el => el.name && el.type !== 'hidden');

      const reqCountEl = document.getElementById('reqCount');
      const doneCountEl = document.getElementById('doneCount');
      const progressFill = document.getElementById('progressFill');

      const kpiReq = document.getElementById('kpiReq');
      const kpiDone = document.getElementById('kpiDone');
      const kpiLeft = document.getElementById('kpiLeft');

      const sections = Array.from(document.querySelectorAll('[data-section]'));
      const navLinks = Array.from(document.querySelectorAll('.nav a[data-nav]'));
      const activeSectionEl = document.getElementById('activeSection');

      function isVisible(el){
        // visible if not inside display:none container
        const style = window.getComputedStyle(el);
        if(style.display === 'none' || style.visibility === 'hidden') return false;
        // also if any parent has display:none
        let p = el.parentElement;
        while(p){
          const ps = window.getComputedStyle(p);
          if(ps.display === 'none') return false;
          p = p.parentElement;
        }
        return true;
      }

      function isFilled(el){
        if(!isVisible(el)) return true; // fields hidden by logic shouldn't block progress
        if(el.type === 'radio'){
          const g = form.querySelector(`input[type="radio"][name="${CSS.escape(el.name)}"]:checked`);
          return !!g;
        }
        if(el.type === 'checkbox'){
          return el.checked;
        }
        return String(el.value || '').trim().length > 0;
      }

      function updateProgress(){
        const requiredVisible = reqEls.filter(isVisible);
        const total = requiredVisible.length;

        let done = 0;
        requiredVisible.forEach(el => { if(isFilled(el)) done++; });

        const pct = total ? Math.round((done/total)*100) : 100;

        if(reqCountEl) reqCountEl.textContent = String(total);
        if(doneCountEl) doneCountEl.textContent = String(done);
        if(progressFill) progressFill.style.width = pct + '%';

        if(kpiReq) kpiReq.textContent = String(total);
        if(kpiDone) kpiDone.textContent = String(done);
        if(kpiLeft) kpiLeft.textContent = String(Math.max(0, total - done));

        // per-section mini progress + dot states
        sections.forEach(sec => {
          const id = sec.id;
          const reqInSec = Array.from(sec.querySelectorAll('[required]')).filter(el => el.name && el.type !== 'hidden' && isVisible(el));
          const totalS = reqInSec.length;
          let doneS = 0;
          reqInSec.forEach(el => { if(isFilled(el)) doneS++; });

          const pctS = totalS ? Math.round((doneS/totalS)*100) : 100;

          const mini = document.getElementById('mini-' + id);
          if(mini) mini.textContent = pctS + '%';

          const dot = document.getElementById('dot-' + id);
          if(dot){
            dot.classList.remove('done','partial');
            if(pctS === 100) dot.classList.add('done');
            else if(pctS > 0) dot.classList.add('partial');
          }
        });
      }

      form.addEventListener('input', updateProgress);
      form.addEventListener('change', updateProgress);
      updateDeps();
      updateProgress();

      // --- Active section highlight (scroll spy) ---
      function setActiveSectionById(id){
        navLinks.forEach(a => a.classList.toggle('active', a.getAttribute('data-nav') === id));
        const idx = sections.findIndex(s => s.id === id);
        if(activeSectionEl && idx >= 0) activeSectionEl.textContent = String(idx + 1);
      }

      function computeActiveSectionId(){
        const viewportAnchor = window.innerHeight * 0.34;
        let bestId = sections[0] ? sections[0].id : 's1';
        let bestDistance = Number.POSITIVE_INFINITY;

        sections.forEach(sec => {
          const rect = sec.getBoundingClientRect();
          if(rect.bottom < 80 || rect.top > window.innerHeight) return;
          const distance = Math.abs(rect.top - viewportAnchor);
          if(distance < bestDistance){
            bestDistance = distance;
            bestId = sec.id;
          }
        });

        return bestId;
      }

      const sectionRatios = new Map();
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => sectionRatios.set(entry.target.id, entry.intersectionRatio));

        let activeId = '';
        let maxRatio = 0;
        sectionRatios.forEach((ratio, id) => {
          if(ratio > maxRatio){
            maxRatio = ratio;
            activeId = id;
          }
        });

        setActiveSectionById(activeId || computeActiveSectionId());
      }, { rootMargin: "-22% 0px -58% 0px", threshold: [0, 0.15, 0.3, 0.45, 0.6, 0.75, 1] });

      sections.forEach(s => observer.observe(s));

      let sectionTicking = false;
      function onViewportUpdate(){
        if(sectionTicking) return;
        sectionTicking = true;
        requestAnimationFrame(() => {
          setActiveSectionById(computeActiveSectionId());
          sectionTicking = false;
        });
      }

      window.addEventListener('scroll', onViewportUpdate, { passive: true });
      window.addEventListener('resize', onViewportUpdate);
      onViewportUpdate();

      // Smooth scroll for nav links + top button
      navLinks.forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const id = a.getAttribute('href');
          const target = document.querySelector(id);
          if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
        });
      });

      const btnTop = document.getElementById('btnTop');
      btnTop && btnTop.addEventListener('click', () => {
        document.getElementById('top').scrollIntoView({behavior:'smooth', block:'start'});
      });

      const btnNext = document.getElementById('btnNext');
      btnNext && btnNext.addEventListener('click', () => {
        const active = document.querySelector('.nav a.active');
        const currentId = active ? active.getAttribute('data-nav') : 's1';
        const idx = sections.findIndex(s => s.id === currentId);
        const next = sections[Math.min(sections.length - 1, idx + 1)];
        if(next) next.scrollIntoView({behavior:'smooth', block:'start'});
      });

      // --- Gentle validation (on submit) ---
      function clearInlineErrors(){
        document.querySelectorAll('.invalid').forEach(w => w.classList.remove('invalid'));
        document.querySelectorAll('.msg.err').forEach(m => m.remove());
      }
      function showError(el, text){
        const wrap = el.closest('.field') || el.parentElement;
        if(!wrap) return;
        wrap.classList.add('invalid');
        el.setAttribute('aria-invalid','true');
        const m = document.createElement('div');
        m.className = 'msg err';
        m.textContent = text;
        wrap.appendChild(m);
      }

      form.addEventListener('submit', (e) => {
        clearInlineErrors();
        updateDeps();
        updateProgress();

        // validate only visible required
        const requiredVisible = reqEls.filter(isVisible);
        let firstBad = null;

        // validate radios by group (avoid duplicate errors)
        const radioGroups = new Set(requiredVisible.filter(x => x.type === 'radio').map(x => x.name));
        radioGroups.forEach(name => {
          const checked = form.querySelector(`input[type="radio"][name="${CSS.escape(name)}"]:checked`);
          if(!checked){
            const any = form.querySelector(`input[type="radio"][name="${CSS.escape(name)}"]`);
            if(any){
              showError(any, 'Seleccione una opción para continuar.');
              firstBad = firstBad || any;
            }
          }
        });

        requiredVisible.forEach(el => {
          if(el.type === 'radio') return;
          if(!isFilled(el)){
            showError(el, 'Este campo es obligatorio.');
            firstBad = firstBad || el;
          }
        });

        if(firstBad){
          e.preventDefault();
          // scroll to the section containing the first error
          const sec = firstBad.closest('[data-section]');
          if(sec) sec.scrollIntoView({behavior:'smooth', block:'start'});
          setTimeout(() => firstBad.focus({preventScroll:true}), 250);
        }else{
          isSubmitting = true;
          // successful submit -> clear autosave so next time it's clean
          try{ localStorage.removeItem(autosaveKey); }catch(_){}
        }
      });
    })();
  </script>
</body>
</html>
